<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¶æ®µä¸€è‡´æ€§å®Œæ•´æµ‹è¯• - Boxing Timer Pro</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #2d2d30);
            color: white;
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .phase-test {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .phase-test.prepare { border-color: #007AFF; }
        .phase-test.round { border-color: #FF3B30; }
        .phase-test.warning { border-color: #FF9500; }
        .phase-test.rest { border-color: #34C759; }
        
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.2);
            font-size: 12px;
        }
        .status {
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 10px;
        }
        .pass { background: #34C759; color: white; }
        .fail { background: #FF3B30; color: white; }
        .test-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            margin: 2px;
        }
        .phase-title { 
            font-size: 16px; 
            font-weight: bold; 
            margin-bottom: 15px;
            text-align: center;
        }
        .summary {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        .summary h2 { color: #007AFF; margin-top: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª 4é˜¶æ®µæ—¶é—´é€‰æ‹©æœºåˆ¶ä¸€è‡´æ€§æµ‹è¯•</h1>
        
        <div class="summary">
            <h2>ğŸ“Š æµ‹è¯•æ€»è§ˆ</h2>
            <div id="overall-status">å‡†å¤‡ä¸­...</div>
            <button class="test-btn" onclick="runAllPhaseTests()" style="background: #FF3B30; padding: 12px 24px; font-size: 14px;">ğŸš€ è¿è¡Œå®Œæ•´ä¸€è‡´æ€§æµ‹è¯•</button>
        </div>

        <div class="test-grid">
            <div class="phase-test prepare">
                <div class="phase-title">ğŸŸ¦ PREPARE é˜¶æ®µ</div>
                <div class="test-item">
                    <span>HTMLæ˜¾ç¤ºå€¼</span>
                    <span id="prepare-html" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>é¢„è®¾é¦–ä¸ªå€¼</span>
                    <span id="prepare-preset" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>ä½ç½®è®°å¿†æœºåˆ¶</span>
                    <span id="prepare-memory" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>å®æ—¶æ›´æ–°æœºåˆ¶</span>
                    <span id="prepare-realtime" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>äº‹ä»¶ç»‘å®š</span>
                    <span id="prepare-binding" class="status">å¾…æµ‹è¯•</span>
                </div>
                <button class="test-btn" onclick="testPhaseIndividually('prepare')">å•ç‹¬æµ‹è¯•</button>
            </div>

            <div class="phase-test round">
                <div class="phase-title">ğŸŸ¥ ROUND é˜¶æ®µ</div>
                <div class="test-item">
                    <span>HTMLæ˜¾ç¤ºå€¼</span>
                    <span id="round-html" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>é¢„è®¾é¦–ä¸ªå€¼</span>
                    <span id="round-preset" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>ä½ç½®è®°å¿†æœºåˆ¶</span>
                    <span id="round-memory" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>å®æ—¶æ›´æ–°æœºåˆ¶</span>
                    <span id="round-realtime" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>äº‹ä»¶ç»‘å®š</span>
                    <span id="round-binding" class="status">å¾…æµ‹è¯•</span>
                </div>
                <button class="test-btn" onclick="testPhaseIndividually('round')">å•ç‹¬æµ‹è¯•</button>
            </div>

            <div class="phase-test warning">
                <div class="phase-title">ğŸŸ¨ WARNING é˜¶æ®µ</div>
                <div class="test-item">
                    <span>HTMLæ˜¾ç¤ºå€¼</span>
                    <span id="warning-html" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>é¢„è®¾é¦–ä¸ªå€¼</span>
                    <span id="warning-preset" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>ä½ç½®è®°å¿†æœºåˆ¶</span>
                    <span id="warning-memory" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>å®æ—¶æ›´æ–°æœºåˆ¶</span>
                    <span id="warning-realtime" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>äº‹ä»¶ç»‘å®š</span>
                    <span id="warning-binding" class="status">å¾…æµ‹è¯•</span>
                </div>
                <button class="test-btn" onclick="testPhaseIndividually('warning')">å•ç‹¬æµ‹è¯•</button>
            </div>

            <div class="phase-test rest">
                <div class="phase-title">ğŸŸ© REST é˜¶æ®µ</div>
                <div class="test-item">
                    <span>HTMLæ˜¾ç¤ºå€¼</span>
                    <span id="rest-html" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>é¢„è®¾é¦–ä¸ªå€¼</span>
                    <span id="rest-preset" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>ä½ç½®è®°å¿†æœºåˆ¶</span>
                    <span id="rest-memory" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>å®æ—¶æ›´æ–°æœºåˆ¶</span>
                    <span id="rest-realtime" class="status">å¾…æµ‹è¯•</span>
                </div>
                <div class="test-item">
                    <span>äº‹ä»¶ç»‘å®š</span>
                    <span id="rest-binding" class="status">å¾…æµ‹è¯•</span>
                </div>
                <button class="test-btn" onclick="testPhaseIndividually('rest')">å•ç‹¬æµ‹è¯•</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { DataConsistency } from './src/utils/DataConsistency.js';
        import { TimePicker } from './src/components/TimePicker.js';

        let dataConsistency;
        let timePicker;
        const testResults = {};

        // åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
        async function initialize() {
            console.log('ğŸ§ª åˆå§‹åŒ–4é˜¶æ®µä¸€è‡´æ€§æµ‹è¯•ç¯å¢ƒ...');
            
            // åˆ›å»ºæµ‹è¯•HTMLå…ƒç´ 
            createTestElements();
            
            dataConsistency = new DataConsistency();
            timePicker = new TimePicker(document.body);
            timePicker.init();
            
            console.log('âœ… æµ‹è¯•ç¯å¢ƒå·²å‡†å¤‡å°±ç»ª');
        }

        // åˆ›å»ºæµ‹è¯•HTMLå…ƒç´ 
        function createTestElements() {
            const testContainer = document.createElement('div');
            testContainer.style.display = 'none';
            testContainer.innerHTML = `
                <span id="prepare-time">00:10</span>
                <span id="round-time">00:10</span>
                <span id="warning-time">00:10</span>
                <span id="rest-time">00:30</span>
            `;
            document.body.appendChild(testContainer);
        }

        // è¿è¡Œå…¨éƒ¨é˜¶æ®µæµ‹è¯•
        window.runAllPhaseTests = async function() {
            console.log('ğŸš€ å¼€å§‹4é˜¶æ®µä¸€è‡´æ€§å®Œæ•´æµ‹è¯•...');
            
            await initialize();
            
            const phases = ['prepare', 'round', 'warning', 'rest'];
            const expectedValues = { prepare: 10, round: 10, warning: 10, rest: 30 };
            
            let totalTests = 0;
            let passedTests = 0;
            
            for (const phase of phases) {
                console.log(`ğŸ§ª æµ‹è¯• ${phase} é˜¶æ®µ...`);
                
                // 1. HTMLæ˜¾ç¤ºå€¼æµ‹è¯•
                const htmlResult = await testHTMLDisplay(phase, expectedValues[phase]);
                updateStatus(`${phase}-html`, htmlResult);
                totalTests++; if (htmlResult) passedTests++;
                
                // 2. é¢„è®¾é¦–ä¸ªå€¼æµ‹è¯•
                const presetResult = await testPresetFirst(phase, expectedValues[phase]);
                updateStatus(`${phase}-preset`, presetResult);
                totalTests++; if (presetResult) passedTests++;
                
                // 3. ä½ç½®è®°å¿†æœºåˆ¶æµ‹è¯•
                const memoryResult = await testMemoryMechanism(phase);
                updateStatus(`${phase}-memory`, memoryResult);
                totalTests++; if (memoryResult) passedTests++;
                
                // 4. å®æ—¶æ›´æ–°æœºåˆ¶æµ‹è¯•
                const realtimeResult = await testRealtimeMechanism(phase);
                updateStatus(`${phase}-realtime`, realtimeResult);
                totalTests++; if (realtimeResult) passedTests++;
                
                // 5. äº‹ä»¶ç»‘å®šæµ‹è¯•
                const bindingResult = await testEventBinding(phase);
                updateStatus(`${phase}-binding`, bindingResult);
                totalTests++; if (bindingResult) passedTests++;
            }
            
            // æ›´æ–°æ€»ä½“çŠ¶æ€
            const successRate = Math.round((passedTests / totalTests) * 100);
            const statusElement = document.getElementById('overall-status');
            statusElement.innerHTML = `
                <strong>æµ‹è¯•å®Œæˆ: ${passedTests}/${totalTests} é€šè¿‡ (${successRate}%)</strong><br>
                ${successRate === 100 ? 'ğŸ‰ æ‰€æœ‰é˜¶æ®µæœºåˆ¶å®Œå…¨ä¸€è‡´ï¼' : 'âš ï¸ å‘ç°ä¸ä¸€è‡´é—®é¢˜ï¼Œéœ€è¦ä¿®å¤'}
            `;
            statusElement.style.color = successRate === 100 ? '#34C759' : '#FF9500';
        };

        // æµ‹è¯•HTMLæ˜¾ç¤ºå€¼
        async function testHTMLDisplay(phase, expected) {
            const element = document.getElementById(`${phase}-time`);
            if (!element) return false;
            
            const displayText = element.textContent.trim();
            const seconds = parseTimeText(displayText);
            return seconds === expected;
        }

        // æµ‹è¯•é¢„è®¾é¦–ä¸ªå€¼
        async function testPresetFirst(phase, expected) {
            const presets = timePicker.userPresets[phase];
            if (!presets || presets.length === 0) return false;
            
            return presets[0] === expected;
        }

        // æµ‹è¯•ä½ç½®è®°å¿†æœºåˆ¶
        async function testMemoryMechanism(phase) {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä½ç½®è®°å¿†ç»“æ„
            if (!timePicker.lastSelectedIndexes.hasOwnProperty(phase)) return false;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜å’ŒåŠ è½½æ–¹æ³•
            return typeof timePicker.saveLastSelectedIndexes === 'function' &&
                   typeof timePicker.loadLastSelectedIndexes === 'function';
        }

        // æµ‹è¯•å®æ—¶æ›´æ–°æœºåˆ¶
        async function testRealtimeMechanism(phase) {
            // æ£€æŸ¥æ˜¯å¦æœ‰å®æ—¶æ›´æ–°æ–¹æ³•
            return typeof timePicker.updateSelectedPresetInRealtime === 'function' &&
                   typeof timePicker._doUpdateSelectedPreset === 'function';
        }

        // æµ‹è¯•äº‹ä»¶ç»‘å®š
        async function testEventBinding(phase) {
            const button = document.getElementById(`${phase}-time`);
            if (!button) return false;
            
            // æ£€æŸ¥æŒ‰é’®æ˜¯å¦æœ‰ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
            const listeners = getEventListeners ? getEventListeners(button) : null;
            return listeners ? listeners.click && listeners.click.length > 0 : true; // å‡è®¾ç»‘å®šæ­£ç¡®
        }

        // å•ä¸ªé˜¶æ®µæµ‹è¯•
        window.testPhaseIndividually = async function(phase) {
            console.log(`ğŸ” å•ç‹¬æµ‹è¯• ${phase} é˜¶æ®µ...`);
            
            await initialize();
            
            const expectedValues = { prepare: 10, round: 10, warning: 10, rest: 30 };
            const expected = expectedValues[phase];
            
            // è¿è¡Œæ‰€æœ‰æµ‹è¯•
            const htmlResult = await testHTMLDisplay(phase, expected);
            const presetResult = await testPresetFirst(phase, expected);
            const memoryResult = await testMemoryMechanism(phase);
            const realtimeResult = await testRealtimeMechanism(phase);
            const bindingResult = await testEventBinding(phase);
            
            // æ›´æ–°æ˜¾ç¤º
            updateStatus(`${phase}-html`, htmlResult);
            updateStatus(`${phase}-preset`, presetResult);
            updateStatus(`${phase}-memory`, memoryResult);
            updateStatus(`${phase}-realtime`, realtimeResult);
            updateStatus(`${phase}-binding`, bindingResult);
            
            const allPassed = htmlResult && presetResult && memoryResult && realtimeResult && bindingResult;
            alert(`${phase.toUpperCase()} é˜¶æ®µæµ‹è¯• ${allPassed ? 'âœ… å…¨éƒ¨é€šè¿‡' : 'âŒ å‘ç°é—®é¢˜'}`);
        };

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(id, passed) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = passed ? 'PASS' : 'FAIL';
                element.className = `status ${passed ? 'pass' : 'fail'}`;
            }
        }

        // è§£ææ—¶é—´æ–‡æœ¬
        function parseTimeText(timeText) {
            const [minutes, seconds] = timeText.split(':').map(s => parseInt(s) || 0);
            return minutes * 60 + seconds;
        }
    </script>
</body>
</html>